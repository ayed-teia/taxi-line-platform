rules_version = '2';

/**
 * Taxi Line Platform - Firestore Security Rules
 * 
 * Architecture principles:
 * - All business logic lives in Cloud Functions
 * - Clients have minimal write access
 * - Most writes go through callable functions
 * - Clients can read their own data in realtime
 */
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =========================================================================
    // Helper Functions
    // =========================================================================
    
    /**
     * Check if the request is authenticated
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /**
     * Check if the authenticated user matches the given uid
     */
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    /**
     * Check if the user has a specific role (stored in custom claims)
     */
    function hasRole(role) {
      return isAuthenticated() && request.auth.token.role == role;
    }
    
    /**
     * Check if user is a manager
     */
    function isManager() {
      return hasRole('manager');
    }
    
    /**
     * Check if user is a driver
     */
    function isDriver() {
      return hasRole('driver');
    }
    
    /**
     * Check if user is a passenger
     */
    function isPassenger() {
      return hasRole('passenger');
    }
    
    /**
     * Check if the user is a participant in a trip (passenger or driver)
     */
    function isTripParticipant() {
      return isAuthenticated() && (
        resource.data.passengerId == request.auth.uid ||
        resource.data.driverId == request.auth.uid
      );
    }
    
    // =========================================================================
    // Default: Deny all access
    // =========================================================================
    match /{document=**} {
      allow read, write: if false;
    }
    
    // =========================================================================
    // Users Collection
    // Path: /users/{uid}
    // 
    // User profile documents containing passenger, driver, or manager data.
    // - Users can read and write their own profile
    // - Managers can read and write all profiles (for admin purposes)
    // - No cross-user access for regular users
    // =========================================================================
    match /users/{uid} {
      // User can read their own document, managers can read any
      allow read: if isOwner(uid) || isManager();
      
      // User can update their own document, managers can update any
      // Note: User creation is handled by Cloud Functions on auth trigger
      allow write: if isOwner(uid) || isManager();
    }
    
    // =========================================================================
    // Driver Live Location Collection
    // Path: /driverLive/{driverId}
    // 
    // Real-time driver location data, isolated from trip documents for
    // performance and security.
    // - Drivers can only write their own location
    // - Location reads are restricted to prevent tracking
    // - Passengers can read location only for their active trip's driver
    // - Managers can read all for monitoring
    // 
    // ⚠️  MVP LIMITATION: Passenger read access is permissive (any passenger
    //     can read any driver location). For production, implement one of:
    //     1. Server-side proxy for location reads
    //     2. Store active trip driverId in passenger's token claims
    //     3. Use a subcollection under trips for location streaming
    // =========================================================================
    match /driverLive/{driverId} {
      // Driver can write their own location only
      allow write: if isOwner(driverId) && isDriver();
      
      // Reading driver location:
      // - Managers can read all (for monitoring dashboard)
      // - Drivers can read their own location
      // - Passengers: MVP allows any passenger to read (see limitation above)
      allow read: if isOwner(driverId) || isManager() || isPassenger();
    }
    
    // =========================================================================
    // Drivers Collection with Inbox Subcollection
    // Path: /drivers/{driverId}
    // Path: /drivers/{driverId}/inbox/{requestId}
    // 
    // Driver availability and profile data:
    // - isOnline: boolean - Driver has toggled to online
    // - isAvailable: boolean - Driver can receive new trips (set by Cloud Functions)
    // - lastLocation: GeoPoint - Last known location
    // - currentTripId: string | null - Current trip if on one
    // - updatedAt: Timestamp
    // 
    // WRITE RULES:
    // - Driver can set isOnline and lastLocation (going online/offline)
    // - Cloud Functions set isAvailable (accept trip = false, complete = true)
    // - Cloud Functions use Admin SDK which bypasses security rules
    // =========================================================================
    match /drivers/{driverId} {
      // Driver can read their own profile, managers can read all
      allow read: if isOwner(driverId) || isManager();
      
      // Driver can update their own document (isOnline, lastLocation)
      // Note: isAvailable is managed by Cloud Functions via Admin SDK
      allow write: if isOwner(driverId) && isDriver();
      
      // Inbox subcollection
      match /inbox/{requestId} {
        // Driver can read their own inbox items
        allow read: if isOwner(driverId) || isManager();
        
        // NO direct writes - inbox is managed by Cloud Functions
        // Cloud Functions use Admin SDK which bypasses security rules
        allow write: if false;
      }
    }
    
    // =========================================================================
    // Driver Requests Collection (Trip Request Notifications)
    // Path: /driverRequests/{driverId}/requests/{tripId}
    // 
    // Real-time trip request notifications sent to drivers by Cloud Functions.
    // - Cloud Functions create requests (Admin SDK bypasses rules)
    // - Drivers can read their own requests
    // - Drivers can update status to accept/reject
    // =========================================================================
    match /driverRequests/{driverId} {
      // Driver can read the parent document
      allow read: if isOwner(driverId) || isManager();
      
      // Requests subcollection
      match /requests/{tripId} {
        // Driver can read their own pending requests
        allow read: if isOwner(driverId) || isManager();
        
        // Driver can update status (accept/reject)
        allow update: if isOwner(driverId) && isDriver() &&
          request.resource.data.status in ['accepted', 'rejected'];
        
        // NO direct creates or deletes - managed by Cloud Functions
        allow create, delete: if false;
      }
    }
    
    // =========================================================================
    // Trips Collection
    // Path: /trips/{tripId}
    // 
    // Trip documents containing full trip lifecycle data.
    // - Passengers can read their own trips (passengerId == uid)
    // - Drivers can read trips assigned to them (driverId == uid)
    // - Managers can read all trips for support and reporting
    // - NO direct client writes - all modifications through Cloud Functions
    // - This ensures trip state machine integrity and proper fare calculation
    // =========================================================================
    match /trips/{tripId} {
      // Passengers can read trips where they are the passenger
      // Drivers can read trips where they are assigned
      // Managers can read all trips
      allow read: if isManager() || (
        isAuthenticated() && (
          resource.data.passengerId == request.auth.uid ||
          resource.data.driverId == request.auth.uid
        )
      );
      
      // NO direct writes allowed - all trip operations go through Cloud Functions
      // Protected fields: status transitions, fare, timestamps, driver assignment
      // Cloud Functions use Admin SDK which bypasses these rules
      allow write: if false;
    }
    
    // =========================================================================
    // Trip Requests Collection
    // Path: /tripRequests/{requestId}
    // 
    // Pending trip requests before driver assignment.
    // - Used for driver matching queue
    // - NO direct client writes - requests created via Cloud Functions
    // - Drivers can read available requests in their area
    // =========================================================================
    match /tripRequests/{requestId} {
      // Drivers can read available requests for matching
      // Passengers can read their own requests
      // Managers can read all
      allow read: if isDriver() || 
                    (isAuthenticated() && resource.data.passengerId == request.auth.uid) ||
                    isManager();
      
      // NO direct writes - trip requests are managed by Cloud Functions
      // This ensures proper validation, pricing, and matching logic
      allow write: if false;
    }
    
    // =========================================================================
    // Routes Collection
    // Path: /routes/{routeId}
    // 
    // Predefined taxi line routes (e.g., Nablus-Ramallah, Ramallah-Jenin).
    // - Manager only for read/write
    // - Routes define stops, typical duration, and base pricing
    // =========================================================================
    match /routes/{routeId} {
      // Only managers can read and write route configuration
      allow read, write: if isManager();
    }
    
    // =========================================================================
    // Pricing Rules Collection
    // Path: /pricingRules/{ruleId}
    // 
    // Dynamic pricing configuration including base fares, per-km rates,
    // surge multipliers, and time-based adjustments.
    // - Manager only access to prevent fare manipulation
    // =========================================================================
    match /pricingRules/{ruleId} {
      // Only managers can read and write pricing rules
      allow read, write: if isManager();
    }
    
    // =========================================================================
    // Ratings Collection
    // Path: /ratings/{tripId}
    // 
    // Trip ratings submitted by passengers after trip completion.
    // - Ratings are created via Cloud Functions (submitRating) for validation
    // - Passengers can read ratings they submitted
    // - Drivers can read ratings for trips where they were the driver
    // - Managers can read all ratings for analytics
    // - NO direct client writes - Cloud Functions handle validation:
    //   * Passenger owns the trip
    //   * Trip status is 'completed'
    //   * No duplicate ratings
    // =========================================================================
    match /ratings/{tripId} {
      // Passengers can read their own ratings
      // Drivers can read ratings for their trips
      // Managers can read all
      allow read: if isManager() || (
        isAuthenticated() && (
          resource.data.passengerId == request.auth.uid ||
          resource.data.driverId == request.auth.uid
        )
      );
      
      // NO direct writes - ratings are created via submitRating Cloud Function
      // Cloud Functions use Admin SDK which bypasses these rules
      // This ensures:
      // - Only passengers can rate their own completed trips
      // - Trip must be in 'completed' status
      // - No duplicate ratings per trip
      // - Trip status is updated to 'rated' atomically
      allow write: if false;
    }
    
    // =========================================================================
    // Driver Availability Collection (Optional - for matching optimization)
    // Path: /driverAvailability/{driverId}
    // 
    // Tracks which drivers are online and available for trips.
    // - Drivers can update their own availability
    // - Managers can read/write all for system management
    // =========================================================================
    match /driverAvailability/{driverId} {
      allow read: if isOwner(driverId) || isManager();
      allow write: if isOwner(driverId) && isDriver();
    }
    
    // =========================================================================
    // FCM Tokens Collection
    // Path: /fcmTokens/{uid}
    // 
    // Push notification tokens for each user.
    // - Users can only write their own tokens
    // - Cloud Functions read tokens to send notifications
    // =========================================================================
    match /fcmTokens/{uid} {
      allow read: if isOwner(uid) || isManager();
      allow write: if isOwner(uid);
    }
  }
}
